
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Getting OpenID working on Heroku</title>
  <meta name="author" content="Funding Gates">

  
  <meta name="description" content="by Matt Rogish (@MattRogish) I just spent the last few days wrestling with OpenID intermittently failing on production, but not test, development, or &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://techblog.fundinggates.com/blog/2013/03/getting-openid-working-on-heroku/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Funding Gates" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-23723423-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Funding Gates</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:techblog.fundinggates.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Getting OpenID Working on Heroku</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-14T20:13:00-04:00" pubdate data-updated="true">Mar 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>by <a href="http://www.mattrogish.com/">Matt Rogish</a> (<a href="https://twitter.com/MattRogish">@MattRogish</a>)</em></p>

<p>I just spent the last few days wrestling with OpenID intermittently failing on production, but not test, development, or staging.</p>

<p>It took me a bit of time to fix, so I thought I&#8217;d enumerate the steps.</p>

<ol>
<li>Use <a href="https://blog.heroku.com/archives/2013/2/27/unicorn_rails">Unicorn</a></li>
<li>Use <a href="https://devcenter.heroku.com/articles/memcachier">MemCachier</a></li>
<li>Use <a href="https://github.com/mperham/dalli">Dalli</a></li>
<li>Use <a href="https://github.com/openid/ruby-openid">ruby-openid</a></li>
<li>Configure OpenID to use Dalli:</li>
</ol>


<p>(set :expires_in to taste)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="o">::</span><span class="no">OpenID</span><span class="o">::</span><span class="no">Consumer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">session</span><span class="p">,</span>
</span><span class='line'>        <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Memcache</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Dalli</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_SERVERS&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">username</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_USERNAME&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">password</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_PASSWORD&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">expires_in</span><span class="p">:</span> <span class="mi">300</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>If you are using <a href="https://github.com/josh/rack-openid">rack-openid</a></li>
</ol>


<p>(set :expires_in to taste)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="s2">&quot;Rack::OpenID&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Memcache</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Dalli</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_SERVERS&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                             <span class="n">username</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_USERNAME&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                             <span class="n">password</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MEMCACHIER_PASSWORD&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                             <span class="n">expires_in</span><span class="p">:</span> <span class="mi">300</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it!</p>

<p>P.S.</p>

<p>The reason why it worked on development and test: we only had a single Unicorn running, so memory storage (the default) worked fine. Staging is running more than one dyno, but since the load was so small it hit the same dyno more often than not, causing it to appear to work when it wasn&#8217;t really.</p>

<p>P.P.S.</p>

<p>You may see guides on the internet that are a few years old suggesting to use filesystem storage:</p>

<p><code>OpenID::Store::Filesystem.new('./tmp')</code></p>

<p>This would only work if you use a single <a href="https://devcenter.heroku.com/articles/dynos">dyno</a> as the filesystem is not shared amongst dynos. Stick with memcached!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Funding Gates</span></span>

      








  


<time datetime="2013-03-14T20:13:00-04:00" pubdate data-updated="true">Mar 14<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://techblog.fundinggates.com/blog/2013/03/getting-openid-working-on-heroku/" data-via="" data-counturl="http://techblog.fundinggates.com/blog/2013/03/getting-openid-working-on-heroku/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/deploying-at-funding-gates/" title="Previous Post: Deploying at Funding Gates">&laquo; Deploying at Funding Gates</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Us</h1>

  <p>We are <a href="http://www.fundinggates.com/">Funding Gates</a>. We make
  web apps for small businesses. This is our community blog.</p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/getting-openid-working-on-heroku/">Getting OpenID working on Heroku</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/deploying-at-funding-gates/">Deploying at Funding Gates</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/moving-emberjs-forward/">Thoughts on Moving Ember.js Forward</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/ember-handlebars-helpers-bound-and-unbound/">Ember Handlebars Helpers, Bound and Unbound</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/capybara-2-0-upgrade-guide/">Capybara 2.0 Upgrade Guide</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Funding Gates -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'fgtechblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://techblog.fundinggates.com/blog/2013/03/getting-openid-working-on-heroku/';
        var disqus_url = 'http://techblog.fundinggates.com/blog/2013/03/getting-openid-working-on-heroku/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
